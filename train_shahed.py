import os
os.environ["TF_CPP_MIN_LOG_LEVEL"] = "2"


from ultralytics import YOLO
import torch
# import tensorflow as tf

# --- –§—É–Ω–∫—Ü—ñ—è, —â–æ —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –≤ –∫—ñ–Ω—Ü—ñ –∫–æ–∂–Ω–æ—ó –µ–ø–æ—Ö–∏ ---
def print_epoch_metrics(trainer):
    # –û—Ç—Ä–∏–º—É—î–º–æ —Å–ª–æ–≤–Ω–∏–∫ –∑ –º–µ—Ç—Ä–∏–∫–∞–º–∏
    metrics = trainer.metrics
    
    # –í–∏—Ç—è–≥—É—î–º–æ –æ—Å–Ω–æ–≤–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ (–∫–ª—é—á—ñ –º–æ–∂—É—Ç—å —Ç—Ä–æ—Ö–∏ –≤—ñ–¥—Ä—ñ–∑–Ω—è—Ç–∏—Å—è –≤ –Ω–æ–≤–∏—Ö –≤–µ—Ä—Å—ñ—è—Ö, –∞–ª–µ –∑–∞–∑–≤–∏—á–∞–π —Ç–∞–∫—ñ)
    # (B) –æ–∑–Ω–∞—á–∞—î Box (–¥–ª—è –¥–µ—Ç–µ–∫—Ü—ñ—ó –æ–±'—î–∫—Ç—ñ–≤)
    map50 = metrics.get("metrics/mAP50(B)", 0)
    precision = metrics.get("metrics/precision(B)", 0)
    recall = metrics.get("metrics/recall(B)", 0)
    
    current_epoch = trainer.epoch + 1
    total_epochs = trainer.epochs

    # –§–æ—Ä–º—É—î–º–æ –≤–ª–∞—Å–Ω–∏–π —Ä—è–¥–æ–∫ –≤–∏–≤–æ–¥—É (–∫–æ–ª—å–æ—Ä–æ–≤–∏–π, —è–∫—â–æ —Ç–µ—Ä–º—ñ–Ω–∞–ª –ø—ñ–¥—Ç—Ä–∏–º—É—î)
    print(f"\nüìä [–ï–ø–æ—Ö–∞ {current_epoch}/{total_epochs}] "
          f"–¢–æ—á–Ω—ñ—Å—Ç—å (P): {precision:.1%} | "
          f"–ü–æ–≤–Ω–æ—Ç–∞ (R): {recall:.1%} | "
          f"mAP@50: {map50:.1%}")

if __name__ == '__main__':
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ GPU (–ø—Ä–æ—Å—Ç–æ –¥–ª—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó)
    print(f"CUDA Available: {torch.cuda.is_available()}")
    # print("Num GPUs:", len(tf.config.list_physical_devices('GPU')))

    # 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –º–æ–¥–µ–ª—å
    model = YOLO('yolov8n.pt')  # –°–∫–∞—á–∞—î –≤–∞–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É
    
    # –î–æ–¥–∞—î–º–æ –Ω–∞—à callback –¥–æ –º–æ–¥–µ–ª—ñ
    model.add_callback("on_fit_epoch_end", print_epoch_metrics)
    
    # 2. –í–∫–∞–∑—É—î–º–æ —à–ª—è—Ö –¥–æ –í–ê–®–û–ì–û –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ data.yaml
    # –í–∞–∂–ª–∏–≤–æ: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ø–æ–≤–Ω–∏–π —à–ª—è—Ö –∞–±–æ –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª –ø–æ—Ä—É—á
    data_path = '/Users/dima_ponzel/Desktop/KNU/ML/TestProjects/1/dataset_test_98/data.yaml' 

    # 3. –ó–∞–ø—É—Å–∫–∞—î–º–æ –Ω–∞–≤—á–∞–Ω–Ω—è
    results = model.train(
        data=data_path,
        epochs=50,             # –î–ª—è —Ç–µ—Å—Ç—É –ø–æ—á–Ω—ñ—Ç—å –∑ 50
        imgsz=640,
        batch=8,              # –Ø–∫—â–æ –º–∞–ª–æ –≤—ñ–¥–µ–æ–ø–∞–º'—è—Ç—ñ - —Å—Ç–∞–≤—Ç–µ 8 –∞–±–æ 4
        device='cpu',              # 0 –¥–ª—è GPU, 'cpu' –¥–ª—è –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞
        workers=0,             # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É –Ω–∞ Windows –∫—Ä–∞—â–µ 0 (—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à–µ)
        project='test_98_local',
        name='run1',
        plots=True
    )

    print("–ù–∞–≤—á–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é
    metrics = model.val()

    # --- –í–∏—Ç—è–≥—É—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ü–∏—Ñ—Ä–∏ ---

    # mAP50 (Mean Average Precision –ø—Ä–∏ IoU 0.5) 
    # –¶–µ –≥–æ–ª–æ–≤–Ω–∏–π –ø–æ–∫–∞–∑–Ω–∏–∫ "–∫—Ä—É—Ç–æ—Å—Ç—ñ" –º–æ–¥–µ–ª—ñ. 
    # –î–ª—è FPV –Ω–∞–º —Ç—Ä–µ–±–∞ —Ö–æ—á–∞ –± 0.6-0.7, —ñ–¥–µ–∞–ª—å–Ω–æ > 0.8.
    print(f"mAP@50: {metrics.box.map50:.3f}")

    # mAP50-95 (–°–µ—Ä–µ–¥–Ω—î –∑–∞ –≤—Å—ñ–º–∞ –ø–æ—Ä–æ–≥–∞–º–∏)
    # –ü–æ–∫–∞–∑—É—î, –Ω–∞—Å–∫—ñ–ª—å–∫–∏ —Ç–æ—á–Ω–æ —Ä–∞–º–∫–∞ –æ–±–ª—è–≥–∞—î –¥—Ä–æ–Ω.
    print(f"mAP@50-95: {metrics.box.map:.3f}")

    # Precision (–¢–æ—á–Ω—ñ—Å—Ç—å): –°–∫—ñ–ª—å–∫–∏ –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –æ–±'—î–∫—Ç—ñ–≤ –¥—ñ–π—Å–Ω–æ —î –®–∞—Ö–µ–¥–∞–º–∏?
    # (–í–∞–∂–ª–∏–≤–æ, —â–æ–± –Ω–µ –∞—Ç–∞–∫—É–≤–∞—Ç–∏ —Å–≤–æ—ó—Ö –∞–±–æ –ø—Ç–∞—Ö—ñ–≤)
    print(f"Precision: {metrics.box.mp:.3f}") # Mean Precision

    # Recall (–ü–æ–≤–Ω–æ—Ç–∞): –°–∫—ñ–ª—å–∫–∏ —Ä–µ–∞–ª—å–Ω–∏—Ö –®–∞—Ö–µ–¥—ñ–≤ –º–∏ –∑–Ω–∞–π—à–ª–∏?
    # (–í–∞–∂–ª–∏–≤–æ, —â–æ–± –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ —Ü—ñ–ª—å)
    print(f"Recall: {metrics.box.mr:.3f}")    # Mean Recall